<!-- Update the video constraints in the startScanning function -->
<script>
    async function startScanning() {
        try {
            logDebug('Starting scanner...');
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            logDebug('Device type: ' + (isMobile ? 'Mobile' : 'Desktop'));

            // Updated video constraints for better mobile support
            const constraints = {
                video: {
                    facingMode: { exact: "environment" }, // Force rear camera on mobile
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 }
                }
            };

            // Fallback if exact "environment" fails
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                logDebug('Camera accessed successfully');
            } catch (err) {
                logDebug('Falling back to basic camera access');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" }
                });
            }

            // Initialize Quagga with updated settings
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector("#interactive"),
                    constraints: {
                        facingMode: { exact: "environment" },
                        aspectRatio: { min: 1, max: 2 },
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 }
                    },
                    area: { // Defines the area of the image to scan
                        top: "0%",    
                        right: "0%",  
                        left: "0%",   
                        bottom: "0%"  
                    },
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader",
                        "code_128_reader",
                        "code_39_reader",
                        "upc_reader"
                    ],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: true,
                        drawScanline: true,
                        showPattern: true
                    }
                },
                locate: true,
                numOfWorkers: navigator.hardwareConcurrency || 4,
            }, function(err) {
                if (err) {
                    showError("Scanner initialization failed: " + err);
                    return;
                }
                logDebug('Quagga initialized successfully');
                Quagga.start();
                document.getElementById('start-button').style.display = 'none';
            });

        } catch (error) {
            showError("Camera access failed: " + error.message);
        }
    }

    // Add this new function for handling orientation changes
    window.addEventListener('orientationchange', function() {
        if (Quagga.isInitialized()) {
            Quagga.stop();
            setTimeout(startScanning, 100); // Restart after orientation change
        }
    });
</script>

<!-- Update the viewport style -->
<style>
    #interactive.viewport {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin: 0 auto;
        position: relative;
    }

    #interactive.viewport > canvas, 
    #interactive.viewport > video {
        width: 100%;
        height: auto;
        max-height: 80vh;
        object-fit: cover;
    }

    /* Add mobile-specific styles */
    @media (max-width: 480px) {
        #interactive.viewport {
            height: 60vh;
            margin-bottom: 20px;
        }

        #interactive.viewport > canvas, 
        #interactive.viewport > video {
            height: 100%;
            object-fit: cover;
        }

        button {
            padding: 15px;
            font-size: 1.1rem;
        }
    }
</style>
